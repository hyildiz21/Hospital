@using Hospital.DB.Model
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@{
    List<string> Iller=ViewData["Iller"] as List<string>;

    List<Polyclinic> polyclinics=ViewData["policlinics"] as List<Polyclinic>;

    List<Doctor> doctors=ViewData["doctors"] as List<Doctor>;
}
@*hasta kayıt ekranı için önce form tagı sonra da inputlar
*@


<body onload="GetDoctor()">
<form>
    
<div class="row col-12">

    <div class="col-6">

        <div class="row col-12">
             <div class="col-3"> <label> TC NO: </label> </div>
             <div class="col-9"> <input type="text" name="tc" id="tc" pattern="[0-9]{11}"  title="İstenilen bilgi 11 haneli sayı" onblur="GetInfo()"> </div>
        </div>

        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> AD: </label> </div>
            <div class="col-9"> <input type="text" name="name" id="name"/> </div>   
        </div>

        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> SOYAD: </label> </div>
            <div class="col-9"> <input type="text" name="surname" id="surname"/> </div>
        </div>

        @*Telefona özel regex*@
        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Telefon No: </label> </div>
            <div class="col-9"> <input type="text" name="phone" id="phone" placeholder="123-123-1234" pattern="[0-9]{10}" /> </div>
        </div>

        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Mail: </label> </div>
            <div class="col-9"> <input type="email" name="mail" id="mail" /> </div>
        </div>

        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Doğum Tarihi: </label> </div>
            <div class="col-9"> <input type="date" name="birthDate" id="birthDate" required/> </div>
        </div>

        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Doğum Yeri: </label> </div>
            <div class="col-9"> 
                <select name="birthplace" id="birthPlace"> @*bunu kod kısmında yazabilirz*@
                    @foreach (var eleman in Iller)
                    {
                        <option value="none" selected disabled hidden> İl Seçiniz </option>

                        <option value="@eleman"> @eleman</option>
                    }                    
                </select>
            </div>
        </div>

       @* Adres bilgisini input yerine textarea*@
        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Adres: </label> </div>
            <div class="col-9">
                <textarea name="adress" id="adress" rows="5"></textarea>
            </div>
        </div>
        <br />
        @*name kısımları sqldeki columnlarla aynı olmalı çünkü çakıştıralım*@
        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Randevu Tarihi: </label> </div>
            <div class="col-9">
                <input type="datetime-local" name="date" id="date"/>
            </div>
        </div>

        @*select te onchange ile metot çağırdık metodu en altta yazdık js ile*@
        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Poliklinikler: </label> </div>
            <div class="col-9">
                <select name="polyclinicId" id="polyclinicId" onchange="GetDoctor()" >
                    <option value="0"> Poliklinik Seçiniz:</option>
                    @*bunu kod kısmında yazabilirz*@
                    @foreach (var eleman in polyclinics)
                    {
                        @*<option value="none" selected disabled hidden> Poliklinik Seçiniz </option>*@
                        @*arkaplanda yani value da id görünürde name basılcak seçtiğimizde idsini seçmiş oluoz*@
                        <option value="@eleman.id"> @eleman.name</option>
                    }
                </select>
            </div>
        </div>

        <div style="margin-top:10px" class="row col-12">
            <div class="col-3"> <label> Doktor: </label> </div>
            <div class="col-9">
                <select name="doctorId" id="doctorId">
                    @*bunu kod kısmında yazabilirz*@
                    
                    @foreach (var eleman in doctors)
                    {
                        @*arkaplanda yani value da id görünürde name basılcak seçtiğimizde idsini seçmiş oluoz*@
                        @*default değer*@
                        @*<option value="none" selected disabled hidden>Doktor Seçiniz</option>*@
                        <option value="@eleman.id"> @eleman.name @eleman.surname</option>
                    }
                </select>
            </div>
        </div>

        <div class="row col-12">
            <div class="col-3"></div>
            <div class="col-9">
                <button style="margin-top:20px" class="btn btn-outline-info" asp-controller="Patient" asp-action="Save"> Sonraki Hastaya Geç</button>
            </div>

    </div>

    </div>


    <div class="col-6"> 
        <table id="dataTable" class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tarih</th>
                    <th>Poliklinik</th>
                    <th>Doktor</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="appointmentTr"> </tbody>
        </table>
    </div>

 </div>
</form>
</body>


<script> 

    function GetDoctor()
    {
        $.ajax({

            url: '@Url.Action("GetDoctor", "Patient")',
            type:"POST",
            data:{polyclinicId: document.getElementById('polyclinicId').value},
            //bu metot başarılı olursa bize dönüş yapan doktorlar=data--- item ın altında data onun altında da doktor
            success: function(data){
                $('#doctorId').find('option').remove();
                if(data.length==0){
                    if (document.getElementById('polyclinicId').value=="0")
                    {
                        select = document.getElementById('doctorId');

                        var opt = document.createElement('option');

                        opt.value = 0;
                        opt.innerHTML = "Öncelikle poliklinik bölümü seçiniz";
                        select.appendChild(opt);
                    }
                    else
                    {
                        select = document.getElementById('doctorId');

                        var opt = document.createElement('option');

                        opt.value = 0;
                        opt.innerHTML = "Bu bölümde doktor bulunmamaktadır.";
                        select.appendChild(opt);
                    }
                }
                $.each(data, function(i,item)
                {
                    select=document.getElementById('doctorId');
                    
                    var opt=document.createElement('option');

                    opt.value=[item.id];
                    opt.innerHTML=[item.name] + " " + [item.surname];
                    select.appendChild(opt);
               
            
                }

            );
            }
            //error: function () 
            //{
            //    $('doctorId').find('option').remove();
            //}
        });
        

    }

    //tc nin çıkışında çalışcak 2 metot
    function GetInfo()
    {
        GetAppointment();
        GetPatient();
    }

    

 

    function GetAppointment()
    {
        var tc= document.getElementById('tc').value;
        $.ajax({
            url: '@Url.Action("GetAppointment", "Patient")',
            type: "POST",
            data: {tc: tc},
            success: function(data){
                $('#dataTable').DataTable().rows().remove().draw();
                //eğer data boş değilse hastanın randevu bilgilerini ekrana ver else gerek yok çünkü
                //227. satırda zaten remove luyoruz.
                if(data!=null)
                {
                $.each(data, function(i, item){
                        var date = 
                        [item.date.split('T')[0].split('-')[2]] + '.' + 
                        [item.date.split('T')[0].split('-')[1]] + '.' + 
                        [item.date.split('T')[0].split('-')[0]] + ' Saat: ' +
                        [item.date.split('T')[1].split(':')[0]] + ':' + 
                        [item.date.split('T')[1].split(':')[1]];

                     $('#dataTable').DataTable().row.add($('<tr>' +
                    '<td>' + [item.id] + '</td>' +
                    '<td>' + date + '</td>' +
                    '<td>' + [item.polyclinicName] + '</td>' +
                    '<td>' + [item.doctorNameSurname] + '</td>' +
                    '<td> <a onclick="GetSelected(' + [item.id] + ',\'' + [item.date] + '\',\'' + [item.polyclinicId] + '\',\'' + [item.polyclinicName] + '\',\'' + [item.doctorId] + '\',\'' + [item.doctorNameSurname] + '\');" > <i class="bi bi-box-arrow-in-down"></i> </a> </td > ' +
                    '</tr>')).draw();
                    
                    
                });
                $("#dataTable").DataTable().order([1, 'desc']).draw(); //datatabledaki tarihleri sıralama controllerdan alınan.
                }
            }
        });
    }

    //hasta ve randevu bilgilerini ikiye ayırdık yukarda getinfoda birlikte çalıştırcaz
    function GetPatient()
    {
        var tc=document.getElementById('tc').value;
        $.ajax(
            {
                url: '@Url.Action("GetPatient","Patient")',
                type: "POST",
                data: {tc: tc},
                success: function(data)
                {
                    //HASTA İÇİN
                    //textboxların datanın boş veya dolu olmasına göre aktif ve boş olma durumları için if kontrolü
                    if(data==null)
                    {
                        //ekrana yazdıktan sonra aktif
                        document.getElementById('name').disabled = false;
                        document.getElementById('surname').disabled = false;
                        document.getElementById('phone').disabled = false;
                        document.getElementById('mail').disabled = false;
                        document.getElementById('birthDate').disabled = false;;
                        document.getElementById('birthPlace').disabled = false;
                        document.getElementById('adress').disabled = false;

                        //textbox içindeki alanları boşaltma
                        document.getElementById('name').value = "";
                        document.getElementById('surname').value = "";
                        document.getElementById('phone').value = "";
                        document.getElementById('mail').value = "";
                        document.getElementById('birthDate').value = "";
                        document.getElementById('birthPlace').value = "";
                        document.getElementById('adress').value = "";
                    }
                    else
                    {
                        document.getElementById('name').value = data.name;
                        document.getElementById('surname').value = data.surname;
                        document.getElementById('phone').value = data.phone;
                        document.getElementById('mail').value = data.mail;
                        document.getElementById('birthDate').value = data.birthDate.split('T')[0];
                        document.getElementById('birthPlace').value = data.birthPlace;
                        document.getElementById('adress').value = data.adress;

                        //ekrana yazdıktan sonra deaktif
                        document.getElementById('name').disabled = true;
                        document.getElementById('surname').disabled = true;
                        document.getElementById('phone').disabled = true;
                        document.getElementById('mail').disabled = true;
                        document.getElementById('birthDate').disabled = true;;
                        document.getElementById('birthPlace').disabled = true;
                        document.getElementById('adress').disabled = true;
                    }




                    //document.getElementById('name').readOnly=true;


                }
            });
    }

    //yukarıya id ve tarih parametresi gönderdik a nın içine GetAppointmentda
    function GetSelected(id, date, polyclinicId, polyclinicName, doctorId, doctorNameSurname) {
        
        //alttaki satır tab a basınca isimleri deaktif hale getiricek bi yol.
        //document.getElementById('name').readOnly=true;
        document.getElementById('date').value=date;

        //HATALI KOD
        //select = document.getElementById('polyclinicId');
        //var opt = document.createElement('option');
        ////option ı oluşturduk ve seçicez yani kayıtlı olan(randevudaki) polyclinici ekrana yazdırıcaz opt nin selected metodu ama her seferinde seçili bölümü bi daha eklio ÇÖZZZ!


        //opt.value = polyclinicId;
        //opt.innerHTML = polyclinicName;
        //opt.selected = "selected"
        //select.appendChild(opt);

        //polyclinicId sinin indexini valuesunu bulcaz. -value dan indexi çekebiliriz-
        select = document.getElementById('polyclinicId');
        var opt=select.options;

        //optionslar içinde döndüm ve polyId si eşit olanı getirdim ekrana
        $.each(opt, function (i, item)
        {
            if(item.value==polyclinicId)
            {
                select.options.selectedIndex=item.index;
            }


        });



        GetDoctor();

        //tıklaya icona basınca aynı olayı doctor için de istiyorum tabi yukarda id ve namelerini parametre olarak verip "a" da basmam gerek
        select = document.getElementById('doctorId');
        var opt = document.createElement('option');

        opt.value = doctorId;
        opt.innerHTML = doctorNameSurname;
        opt.selected = "selected"
        select.appendChild(opt);





    }


</script>